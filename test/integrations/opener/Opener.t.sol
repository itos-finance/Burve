// SPDX-License-Identifier: BUSL-1.1
pragma solidity ^0.8.27;
import {BurveForkableTest} from "../Fork.u.sol";
import {Opener} from "../../../src/integrations/opener/Opener.sol";
import {MAX_TOKENS} from "../../../src/multi/Constants.sol";
import {IERC20} from "openzeppelin-contracts/token/ERC20/IERC20.sol";
import {console2} from "forge-std/console2.sol";
import {Create2Deployer} from "../../utils/Create2Deployer.sol";
import {IOBRouter} from "../../../src/integrations/opener/IOBRouter.sol";
import {FullMath} from "../../../src/FullMath.sol";

contract TestOpener is BurveForkableTest {
    Opener opener;
    Create2Deployer create2Deployer;
    bytes32 internal constant OPENER_SALT = keccak256("opener-test-salt");

    function deployOpenerDeterministically() internal returns (Opener) {
        if (address(create2Deployer) == address(0)) {
            create2Deployer = new Create2Deployer();
        }
        bytes memory bytecode = abi.encodePacked(
            type(Opener).creationCode,
            abi.encode(0xFd88aD4849BA0F729D6fF4bC27Ff948Ab1Ac3dE7)
        );
        address addr = create2Deployer.deploy(bytecode, OPENER_SALT);
        return Opener(addr);
    }

    function testTwoTokenOpener() public {
        opener = deployOpenerDeterministically();

        // note these inputs and params info must be generated by the swap.mjs file.
        address inputToken = address(
            0x0555E30da8f98308EdB960aa94C0Db47230d2B9c
        );
        uint256 inputAmount = 100000000;
        address outputToken = address(
            0x541FD749419CA806a8bc7da8ac23D346f2dF8B77
        );
        uint256 outputQuote = 999779754633815246;
        uint256 outputMin = 989781957087477093;
        address outputReceiver = address(
            0xed63E871F5de87cb1919671eE9e2d331183Eda8f
        );

        deal(inputToken, address(this), 5e18);
        IERC20(inputToken).approve(address(opener), 5e18);

        IOBRouter.swapTokenInfo memory info = IOBRouter.swapTokenInfo({
            inputToken: inputToken,
            inputAmount: inputAmount,
            outputToken: outputToken,
            outputQuote: outputQuote,
            outputMin: outputMin,
            outputReceiver: outputReceiver
        });

        bytes[MAX_TOKENS] memory params;
        params[1] = abi.encodeWithSelector(
            IOBRouter.swap.selector,
            info,
            hex"541FD749419CA806a8bc7da8ac23D346f2dF8B77010000000000000000000000000000000000000000000000000ddfee63c89364ce00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000db54e0a597c5300010555E30da8f98308EdB960aa94C0Db47230d2B9c01ffff09BE09E71BDc7b8a50A05F7291920590505e3C7744cbef1b65399065c2de2c495971e90466ff38f2d000000000000000000000001e541FD749419CA806a8bc7da8ac23D346f2dF8B77062a2b0eea575f659a1aaf18c1df5d93e0528245",
            address(0x062a2B0eeA575f659a1aaf18c1DF5D93E0528245),
            2
        );

        uint16 closureId = 6;
        uint256 bgtPercentX256 = 0;
        uint256[MAX_TOKENS] memory amountLimits;
        opener.mint(
            diamond,
            inputToken,
            2e8,
            params,
            closureId,
            bgtPercentX256,
            amountLimits,
            0
        );
    }

    function testThreeTokenOpener() public {
        opener = deployOpenerDeterministically();

        // note these inputs and params info must be generated by the swap.mjs file.
        address inputToken = address(
            0x0555E30da8f98308EdB960aa94C0Db47230d2B9c
        );
        uint256 inputAmount = 100000000;
        address outputToken = address(
            0x541FD749419CA806a8bc7da8ac23D346f2dF8B77
        );
        uint256 outputQuote = 999949888810858131;
        uint256 outputMin = 989950389922749549;
        address outputReceiver = address(
            0x93F0a330cfF0B4Db85239Dd56F11DaD947196300
        );

        deal(inputToken, address(this), 5e18);
        IERC20(inputToken).approve(address(opener), 5e18);

        IOBRouter.swapTokenInfo memory info = IOBRouter.swapTokenInfo({
            inputToken: inputToken,
            inputAmount: inputAmount,
            outputToken: outputToken,
            outputQuote: outputQuote,
            outputMin: outputMin,
            outputReceiver: outputReceiver
        });

        bytes[MAX_TOKENS] memory params;
        params[1] = abi.encodeWithSelector(
            IOBRouter.swap.selector,
            info,
            hex"541FD749419CA806a8bc7da8ac23D346f2dF8B77010000000000000000000000000000000000000000000000000ddfeb59662d8d2c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000db54e0a597c5300010555E30da8f98308EdB960aa94C0Db47230d2B9c01ffff09BE09E71BDc7b8a50A05F7291920590505e3C7744cbef1b65399065c2de2c495971e90466ff38f2d000000000000000000000001e541FD749419CA806a8bc7da8ac23D346f2dF8B77062a2b0eea575f659a1aaf18c1df5d93e0528245",
            address(0x062a2B0eeA575f659a1aaf18c1DF5D93E0528245),
            2
        );

        // second swap we need to make, also needs to be generated
        inputToken = address(0x0555E30da8f98308EdB960aa94C0Db47230d2B9c);
        inputAmount = 100000000;
        outputToken = address(0x549943e04f40284185054145c6E4e9568C1D3241);
        outputQuote = 104624253094;
        outputMin = 103578010563;
        outputReceiver = address(0x93F0a330cfF0B4Db85239Dd56F11DaD947196300);
        info = IOBRouter.swapTokenInfo({
            inputToken: inputToken,
            inputAmount: inputAmount,
            outputToken: outputToken,
            outputQuote: outputQuote,
            outputMin: outputMin,
            outputReceiver: outputReceiver
        });

        params[0] = abi.encodeWithSelector(
            IOBRouter.swap.selector,
            info,
            hex"549943e04f40284185054145c6E4e9568C1D324100000000000000000000000000000000000000000000000000000000185c1768a60000000000000000000000000000000000000000000000000000000ae0621aaf000000000000000000000000000000000000000000000000000000185b092df0010555E30da8f98308EdB960aa94C0Db47230d2B9c044eef013c098ca2e84143742A7dCeC3a341caBdd706412B01062a2b0eea575f659a1aaf18c1df5d93e05282450316016e7ccf517D0fFFAB689cE85C18C0d292eE4D004A01062a2b0eea575f659a1aaf18c1df5d93e05282451c1901DDD01143BF7639b40C7063a9376052fB9a7DD64001062a2b0eea575f659a1aaf18c1df5d93e0528245ffff01545Bea6Ea7F8fD8dCC5C9A6802a8ebF3DbFc1C6E01062a2b0eea575f659a1aaf18c1df5d93e052824501696969696969696969696969696969696969696902e385011127f801Cb3ab7BDF8923272949AA7Dba94B580501062a2b0eea575f659a1aaf18c1df5d93e0528245ffff1979d95c5e6225f8b13aaee43550232df7f357b208fcbd14dc51f0a4d49d5e53c2e0950e0bc26d0dce062a2b0eea575f659a1aaf18c1df5d93e05282450000000000000000000000000000000000000000000000000000000000000b730000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000005c504e41550100000003b801000000040d00d553561cab1b76b2c2f83d0024f52e1b2431a6262fa13a974347761f83cad6ac1d0573bc62988df6896e536d5d3621d9cec44c00b57fde3a12ad64b5c3589c400102489cd440dcc9325f22702ed8bc02b9e8f9013059590297db33de55aa1946d4c01ade7a2732772419ae7a788536f6b61006e56ebf3cb779ca1ba3ba1112b963d1010307f7743931826136f18b92b8d350f1d52f5123e8835245898a437036cc929090361cda966151a2bdb082da942db335a1a4834c0b1e5a262d68c1efd755e3552c0104110df75f4eea44c644ab8f2703a0df1984e482f0368880cbee7b2fc078c43d6c26ece15578310995bedf924778d679e23e2bdad0694d59f68e4a32b8c0a46b520106a2cf8913cfa97db7d9d6b48ffb807ed58e3518087511b9f6343acfecd821e89b0baf243849787c249048d7398c3f2a698c8d196792a222e75a04d8beb1f31b6c010870878afec2cce2e068a69570bc7c84aff36d233757a133a97b580a2a35eb6e61181afef6429275cb092d99fb17386aab8a32aab5af9e78b571dc0cc23723df6e000a07fe0b049f95fee8b89d082dbaff1de84c8700ea1eea9f8e6c037f09ec4fa6d626ec99d96b04e8b004c25543092f1a8f23842d36a0994010d6ef3c9228f5d91e010b1098956e3c0dae8415a05de3b43c582f805682dc0b8679a3fead544d44231dfc5d05854e3298780ed4995399b8e8558e2940ceb42e0eca9d102b97f37ba8a1fe000c49d5e7058c3dc2a89c85218a382ddcd61dfe22367e4c4b8f31ab52c2834963a268d25267912e18663de08e47e2870d33e51b3f266a4837059d8bf7e54baa2fb0010dfa4dca87bf115233390a68c8898e3ebd59f9213ef9c71120d460ce75de21cc7c3e29281973dbceea19f06526f0cd3f7ed95a17c90a30bdca9719d07c8d1b0035010e6fd28f4664de47c7e96a51b811a53655a4615b01a7027073510e4aa3c735c085448de3c04bbbd3548e99e221e0c04a71b4dea456aef769ae25414fe18447e87e0110acb47e28ccb60b874ff110b2e29867d3c9c9e49a1ec8b9e67819d6528806e63b0fb905049d2dc88cc60857e257cced7efa72bc9359b030a0d084094bb7d7eb3c01117831928e00e70856dc775270c65ddb76c299768cff202ac4f8e5a0438cdd55fb6d78001b0570e918276a40fa9d02a0611b795abb60c4af5cd237ad9316bb3be601684f626900000000001ae101faedac5851e32b9b23b5f9411a8c2bac4aae3ed4dd7b811dd1a72ea4aa71000000000847b95d014155575600000000000d554351000027109ba278a6563aa61c79a5c2813cbb13730b32e8c106005500962088abcfdbdb6e30db2e340c8cf887d9efb311b1f2f17b155a63dbb6d40265000000000c32f644000000000003d83ffffffff800000000684f626900000000684f6269000000000c361b43000000000003863f0c693290267c608d33029501bfc907000026584852417ce23327add86a8eccf95cfb6fe584b03be77076922ae2edad5ab0028c758d9fffaf5ae5ebb608e5f3c4555d8811b989a9d80fdbff317fd91e611ef3f49b3d21679e9f2df354381eb53b976949dc614760593c2e9c528858dcd8fddf979863731005466c0b91426ee67ce3294c912c9b277be95445009dab4ba2bad86ce44ac60e1adcbd4a2b3f2b46cd6c0d0d406d2d9d933c86b68e35a0790bb06561b16e41c1b1330ffb5ce36e5c8a03c36d75099f8abea4c5eb3bbec7bd1bd1fcabb1a02c6e8cee158db5ba1298dc41735224814a10bed44e48910eff2517fb005500f67b033925d73d43ba4401e00308d9b0f26ab4fbd1250e8b5407b9eaade7e1f40000000005f3d2dc000000000002c166fffffff800000000684f626900000000684f62690000000005f4a570000000000002bfed0c137966bcc1751b32d329602ab0f23a9f6786708b0d9d2c639c4b8cfb44cb368c1ae3272620cf222ade864e418cad106a4a1d9648395155fa126785e3ff237434166872f08940eaa032121ec96b42e28084abd7d1e84115887bafa919abd70e623bc469088b56313fa6422d371e803e09f62d64c2d4328a249d48766d13ce007def0a519e428e1a63e47139fa88a062153862da9534ea76f9a84d9f4dbb04e39747d3adfc9fd31534f156d9f3042ce8fffdd357c6f3b4e9d8f7613fe5fd17cb6ae5917eb4965915e3910324ab7cc956c2b1a7d946f8a55c116a45e97a1298dc41735224814a10bed44e48910eff2517fb0055007d80a0d7344c6632c5ed2b85016f32aed4f831294e274739d92bb9e32df5b22f000000000d92098e00000000000cbbe0fffffff800000000684f626900000000684f6269000000000d917eb600000000000bfd190cfebf08c79b251b371efb6fa8c2a27a0e643a33d6673fb26198cdde8ed209c29c10a56572a26cce369ceb37e55be36539fc4fc0dabd9034ce13248a177a2b94329933b645a6d18adc81979b44a0d27e629b7df8013c9d81e507de9d91835effb1e0e755e23bf88d795469033654ada02a5d767ba3b10281e76c6430aeaee6198230d11d23954e6145bc7dedcee32cb446ca190380846e25fe0022aa4d26f44f03e847a32afb08ed9cf792db2ac112b038f43b601e41c1b1330ffb5ce36e5c8a03c36d75099f8abea4c5eb3bbec7bd1bd1fcabb1a02c6e8cee158db5ba1298dc41735224814a10bed44e48910eff2517fb005500eaa020c61cc479712813461ce153894a96a6c00b21ed0cfc2798d1f9a9e9c94a0000000005f5a065000000000001b469fffffff800000000684f626900000000684f62690000000005f5a4e5000000000001b6290c7fba84bc15f11992b9859951d56db008d9e90f69674648b3a29f5c73b71eb01a39a2903434efe2df4a7bca9b871acf0a5f684faed3a98f5ef8e61d35b6656f643838736d70eb1338c5d2d5b3b9d0490a80c6a44185f2e87440aed6aa848aeefe9f8f22b184fae3c152410a07ab6747bd072c7d735f64400877a77b0cc068edcfa9466f28eae6cf60140c3bcb88a062153862da9534ea76f9a84d9f4dbb04e39747d3adfc9fd31534f156d9f3042ce8fffdd357c6f3b4e9d8f7613fe5fd17cb6ae5917eb4965915e3910324ab7cc956c2b1a7d946f8a55c116a45e97a1298dc41735224814a10bed44e48910eff2517fb005500c929105a1af143cbfc887c4573947f54422a9ca88a9e622d151b8abdf5c2962f000000000f60d2ed0000000000059ccdfffffff800000000684f626900000000684f6269000000000f5a6d140000000000088ce90c3c694d42f64330997fabcc4f4d9c163ed0a5b26f4d8a074eecd2373435eaaaafcada2f820a100cbcff45b8ec4622508ee81ae438afde24389d558ca90483fb82a25864cd139af94ce96b5aabcc7e362df59cf67c0b3778a04efb4bf0489ddb97d69c82a6d31352f22d53e33d4f89c07fb13c6d2b86d80603cef83826473be841c664d7c6a81195f6622d1a6af97cb7a660363482ca81fe071958c3584d0026eda161676c3b961036c077703c1d841989edb4dba2f3b4e9d8f7613fe5fd17cb6ae5917eb4965915e3910324ab7cc956c2b1a7d946f8a55c116a45e97a1298dc41735224814a10bed44e48910eff2517fb005500c1da1b73d7f01e7ddd54b3766cf7fcd644395ad14f70aa706ec5384c59e766920000000005f54a9b000000000002965ffffffff800000000684f626900000000684f62690000000005f57245000000000002c9610cfcc5926711964d10aef713e8770e37d75bc21742b0100b3ad9fffd05173b17324d60419b30b4d9d431db88ba30b10ca0c7e93b46553b6ba04ab36a88f109d94e6c5386c088734337bba19e1cad0e9664824a8e7743496485c0b32c14cb69745a973a5174fb5d21762d329be86ed7a92df2807b1720da8438cef83826473be841c664d7c6a81195f6622d1a6af97cb7a660363482ca81fe071958c3584d0026eda161676c3b961036c077703c1d841989edb4dba2f3b4e9d8f7613fe5fd17cb6ae5917eb4965915e3910324ab7cc956c2b1a7d946f8a55c116a45e97a1298dc41735224814a10bed44e48910eff2517fb00000000000000000000000000012F6F07CDcf3588944Bf4C42aC74ff24bF56e759002ebc8019EB897D400f245E151daFD4c81176397D7798C9c01062a2b0eea575f659a1aaf18c1df5d93e0528245ffff012a15F1715Fb1B2Be49879D92Ced3BCeB1Ca6FAF901062a2b0eea575f659a1aaf18c1df5d93e052824501FCBD14DC51f0A4d49d5E53C2E0950e0bC26d0Dce040aaa09BE09E71BDc7b8a50A05F7291920590505e3C7744d10e65a5f8ca6f835f2b1832e37cf150fb955f23000000000000000000000004549943e04f40284185054145c6E4e9568C1D3241062a2b0eea575f659a1aaf18c1df5d93e05282454de901b16fFD445d3c785476F87017b79423eC9057406b00062a2b0eea575f659a1aaf18c1df5d93e0528245499a01d667467e27cD3Ff1845f08C2D9e638B57DDc75c300062a2b0eea575f659a1aaf18c1df5d93e0528245ffff094Be03f781C497A489E3cB0287833452cA9B9E80Bf961a8f6d8c69e7321e78d254ecafbcc3a637621000000000000000000000001549943e04f40284185054145c6E4e9568C1D3241062a2b0eea575f659a1aaf18c1df5d93e0528245",
            address(0x062a2B0eeA575f659a1aaf18c1DF5D93E0528245),
            2
        );

        uint16 closureId = 7;
        uint256 bgtPercentX256 = 0;
        uint256[MAX_TOKENS] memory amountLimits;
        opener.mint(
            diamond,
            inputToken,
            3e8,
            params,
            closureId,
            bgtPercentX256,
            amountLimits,
            0
        );
    }
}
